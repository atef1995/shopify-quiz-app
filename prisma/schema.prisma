// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// PostgreSQL configuration for production deployment
// SQLite for local development
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

// Quiz models for the QuizCraft app
model Quiz {
  id          String  @id @default(cuid())
  shop        String
  title       String
  description String?
  status      String  @default("draft") // draft, active, archived

  // Settings stored as JSON
  settings String? // { emailCapture: true, resultPageTitle: "Your Perfect Products", etc. }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  questions Question[]
  results   QuizResult[]
  analytics QuizAnalytics?

  @@index([shop])
}

model QuestionAnalytics {
  id         String   @id @default(cuid())
  questionId String   @unique
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // Question-level metrics
  views         Int     @default(0) // How many times this question was shown
  completions   Int     @default(0) // How many times this question was answered
  dropOffs      Int     @default(0) // How many times users dropped off at this question
  averageTime   Float?  // Average time spent on this question (seconds)

  // Answer distribution stored as JSON
  // Example: { "optionId1": count, "optionId2": count, "customAnswer": count }
  answerDistribution String?

  updatedAt DateTime @updatedAt
}

model Question {
  id     String @id @default(cuid())
  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  text  String
  type  String // multiple_choice, image_choice, text_input
  order Int

  // Conditional logic stored as JSON
  // Example: { showIf: { questionId: "xyz", answerContains: "yes" } }
  conditionalRules String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  options QuestionOption[]
  analytics QuestionAnalytics?

  @@index([quizId])
}

model QuestionOption {
  id         String   @id @default(cuid())
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  text     String
  imageUrl String?

  // Product matching logic stored as JSON
  // Example: { tags: ["skincare", "moisturizer"], collections: ["winter-care"] }
  productMatching String?

  order Int

  createdAt DateTime @default(now())

  @@index([questionId])
}

model QuizResult {
  id     String @id @default(cuid())
  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  // Customer information
  email      String?
  customerId String?

  // Quiz answers stored as JSON
  // Example: [{ questionId: "xyz", answerId: "abc", answerText: "Yes" }]
  answers String

  // Recommended products stored as JSON array of product IDs
  recommendedProducts String

  // Tracking
  startedAt           DateTime? // When user started the quiz
  completedAt         DateTime  @default(now())
  completionTimeSeconds Float?  // Total time spent on quiz in seconds
  convertedAt         DateTime? // When customer made a purchase
  revenue             Float?    @default(0.0)

  // Advanced tracking stored as JSON
  // Example: { questionTiming: { q1: 15.2, q2: 8.7 }, dropOffQuestion: "q3" }
  advancedTracking String?

  @@index([quizId])
  @@index([email])
  @@index([completedAt])
}

model QuizAnalytics {
  id     String @id @default(cuid())
  quizId String @unique
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  // Basic Metrics
  totalViews        Int   @default(0)
  totalCompletions  Int   @default(0)
  emailCaptureCount Int   @default(0)
  totalRevenue      Float @default(0.0)

  // Advanced Analytics - stored as JSON
  // {
  //   averageCompletionTime: number,
  //   dropOffPoints: { questionId: dropOffCount },
  //   conversionFunnel: { step: conversionRate },
  //   questionMetrics: { questionId: { views, completions, avgTime } },
  //   timeBasedMetrics: { hourly: [...], daily: [...] },
  //   userSegments: { segment: metrics }
  // }
  advancedMetrics String?

  updatedAt DateTime @updatedAt
}

// Subscription and billing model
model Subscription {
  id   String @id @default(cuid())
  shop String @unique

  // Subscription tier: free, growth, pro, enterprise
  tier String @default("free")

  // Usage tracking for current billing period
  currentPeriodCompletions Int      @default(0)
  currentPeriodStart       DateTime @default(now())
  currentPeriodEnd         DateTime

  // Shopify billing details - tracks actual Shopify recurring application charges
  shopifySubscriptionId String? // GraphQL ID from appSubscriptionCreate (e.g., gid://shopify/AppSubscription/123)
  chargeId              String? // Numeric ID for REST API compatibility
  confirmationUrl       String? // URL merchant visits to approve charge
  returnUrl             String? // URL to redirect after approval
  status                String  @default("active") // active, pending, cancelled, expired

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shop])
  @@index([shopifySubscriptionId])
}

model WebhookSettings {
  id     String @id @default(cuid())
  shop   String @unique

  // Webhook URLs for different events
  quizStartedUrl     String? // Called when a user starts a quiz
  questionAnsweredUrl String? // Called when a user answers a question
  quizCompletedUrl   String? // Called when a user completes a quiz
  emailCapturedUrl   String? // Called when an email is captured

  // Security settings
  webhookSecret String? // Secret for webhook signature verification

  // Status
  enabled Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shop])
}
